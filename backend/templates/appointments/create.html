{% extends "base.html" %}
{% block title %}Запись на приём — Mediscan{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
  <h1 class="text-2xl font-semibold">Запись на приём</h1>

  {% if service %}
    <p class="mt-2 text-slate-600">
      Услуга: <span class="font-semibold text-slate-900">{{ service.name }}</span>
      <span class="text-slate-400">({{ service.category.name }})</span>
    </p>
  {% else %}
    <p class="mt-2 text-slate-600">Выберите услугу на странице услуг и нажмите “Записаться”.</p>
  {% endif %}

  <div class="mt-6 bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
    <form method="post" class="space-y-4">
      {% csrf_token %}

      {% if service %}
        <input type="hidden" name="service_id" value="{{ service.id }}">
      {% endif %}

      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Имя</label>
        <input
          name="full_name"
          value="{{ form.full_name.value|default:'' }}"
          class="w-full rounded-xl border-slate-200 focus:border-slate-400 focus:ring-0"
          placeholder="Например: Анна Иванова">
        {% if form.full_name.errors %}
          <div class="mt-1 text-sm text-red-600">{{ form.full_name.errors.0 }}</div>
        {% endif %}
      </div>

      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Телефон</label>
        <input
          name="phone"
          value="{{ form.phone.value|default:'' }}"
          class="w-full rounded-xl border-slate-200 focus:border-slate-400 focus:ring-0"
          placeholder="+7 (999) 000-00-00">
        {% if form.phone.errors %}
          <div class="mt-1 text-sm text-red-600">{{ form.phone.errors.0 }}</div>
        {% endif %}
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Дата</label>
          <input
            type="date"
            name="preferred_date"
            value="{{ form.preferred_date.value|default:'' }}"
            class="w-full rounded-xl border-slate-200 focus:border-slate-400 focus:ring-0">
          {% if form.preferred_date.errors %}
            <div class="mt-1 text-sm text-red-600">{{ form.preferred_date.errors.0 }}</div>
          {% endif %}
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Время</label>
          <select
            name="preferred_time"
            class="w-full rounded-xl border-slate-200 focus:border-slate-400 focus:ring-0">
            {% for value, label in form.preferred_time.field.choices %}
              <option value="{{ value }}" {% if form.preferred_time.value == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          {% if form.preferred_time.errors %}
            <div class="mt-1 text-sm text-red-600">{{ form.preferred_time.errors.0 }}</div>
          {% endif %}
          <div class="mt-1 text-xs text-slate-500">Слоты каждые 20 минут (08:00–20:40).</div>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Комментарий (необязательно)</label>
        <textarea
          name="comment"
          rows="3"
          class="w-full rounded-xl border-slate-200 focus:border-slate-400 focus:ring-0"
          placeholder="Например: удобно после 18:00">{{ form.comment.value|default:'' }}</textarea>
        {% if form.comment.errors %}
          <div class="mt-1 text-sm text-red-600">{{ form.comment.errors.0 }}</div>
        {% endif %}
      </div>

      <div class="pt-2 flex gap-3">
        <button
          class="rounded-xl bg-slate-900 text-white px-4 py-2 text-sm font-medium hover:bg-slate-800">
          Отправить заявку
        </button>

        <a
          href="{% url 'services:list' %}"
          class="rounded-xl border border-slate-200 px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50">
          К услугам
        </a>
      </div>

      {% if form.non_field_errors %}
        <div class="mt-2 text-sm text-red-600">{{ form.non_field_errors.0 }}</div>
      {% endif %}
    </form>
  </div>
</div>

<script>
(function () {
  const dateInput = document.querySelector('input[name="preferred_date"]');
  const timeSelect = document.querySelector('select[name="preferred_time"]');

  // Берём serviceId максимально надёжно:
  // 1) из скрытого input service_id (если есть)
  // 2) из шаблонного service.id (если есть)
  const hiddenService = document.querySelector('input[name="service_id"]');
  const serviceId = (hiddenService && hiddenService.value) ? hiddenService.value : "{{ service.id|default:'' }}";

  if (!dateInput || !timeSelect || !serviceId) return;

  function setOptions(label) {
    timeSelect.innerHTML = "";
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = label;
    timeSelect.appendChild(opt);
  }

  async function loadSlots() {
    const d = dateInput.value;
    if (!d) {
      setOptions("Выберите дату");
      return;
    }

    setOptions("Загрузка слотов...");

    try {
      const url = `/appointments/slots/?service=${encodeURIComponent(serviceId)}&date=${encodeURIComponent(d)}`;
      const res = await fetch(url, { headers: { "Accept": "application/json" } });

      if (!res.ok) {
        setOptions("Ошибка загрузки слотов");
        return;
      }

      const data = await res.json();
      const slots = Array.isArray(data.slots) ? data.slots : [];

      timeSelect.innerHTML = "";

      if (!slots.length) {
        setOptions("Нет свободных слотов");
        return;
      }

      const prev = timeSelect.getAttribute("data-prev") || "";

      slots.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.value;
        opt.textContent = s.label;
        timeSelect.appendChild(opt);
      });

      // восстановим предыдущее значение, если оно ещё доступно
      if (prev && Array.from(timeSelect.options).some(o => o.value === prev)) {
        timeSelect.value = prev;
      }
    } catch (e) {
      setOptions("Ошибка загрузки слотов");
    }
  }

  timeSelect.addEventListener("change", () => {
    timeSelect.setAttribute("data-prev", timeSelect.value || "");
  });

  dateInput.addEventListener("change", loadSlots);

  // ВАЖНО: загрузка при открытии страницы
  // (особенно если дата уже заполнена или браузер автозаполнил поле)
  setTimeout(loadSlots, 50);
})();
</script>

{% endblock %}